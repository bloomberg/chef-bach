################################################
#
#              Generated by Chef
#
################################################

global
  daemon
  user  haproxy
  group  haproxy
  pidfile  /var/run/haproxy.pid
  log /dev/log local0 info
  # jmx page that is used for httpchk is more than the default size 16384 bytes
  tune.chksize <%= @haproxy_tune_chksize %>

defaults
  log  global
  maxconn  8000
  source <%= @local_management_ip %>
  mode  http
  option abortonclose
  option tcplog
  option dontlognull
  option nolinger
  option  redispatch
  retries  3
  timeout  http-request 10s
  timeout  queue 1m
  timeout  connect 5s
  timeout  check 10s
  timeout  client 30m
  timeout  server 30m

listen stats <%= @local_management_ip%>:1936
  mode http
  stats enable
  stats uri /
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%= "#{@haproxy_stats_user}:#{@haproxy_stats_pwd}" %>

listen stats-vip <%= @management_vip%>:1936
  mode http
  server myself <%= @local_management_ip %>:1936

listen memcached <%= @management_vip %>:11211
  mode tcp
  option tcpka
  server myself 127.0.0.1:11211

<% if @mysql_servers.length > 0 -%>
listen mysql-galera <%= @management_vip %>:3306
  timeout  client 24h
  timeout  server 24h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
  option httpchk
<% @mysql_servers.each do |server| -%>
  <%= "server #{server['fqdn']} #{server['ip']}:3306 check port 3307 inter 1s rise 1 fall 1 observe layer4 backup" %>
<% end -%>
<% end -%>

<% @ha_services.each do |service| -%>
listen <%= "#{service['name']} #{@management_vip}:#{service['port']}" %>
  balance roundrobin
  <% if !service['http_check_url'].nil? and !service['http_check_expect_str'].nil? -%>
  option httpchk GET <%= service['http_check_url'] %>
  http-check expect string <%= service['http_check_expect_str'] %>
  <% end -%>
  source <%= @local_floating_ip %>
  <% service['servers'].each do |server| -%>
  <%= "server #{server['fqdn']} #{server['management_ip']}:#{server['port']} check" %>
  <% end -%>

<% end -%>
