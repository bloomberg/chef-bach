################################################
#
#              Generated by Chef
#
################################################

global
  daemon
  user  haproxy
  group  haproxy
  pidfile  /var/run/haproxy.pid
  log /dev/log local0 info

defaults
  log  global
  maxconn  8000
  source <%="#{node[:bcpc][:management][:vip]}"%>
  mode  http
  option httpclose
  option abortonclose
  option tcplog
  option dontlognull
  option nolinger
  option  redispatch
  retries  3
  timeout  http-request 10s
  timeout  queue 1m
  timeout  connect 5s
  timeout  check 10s
  timeout  client 30m
  timeout  server 30m

listen stats 127.0.0.1:1936
  mode http
  stats enable
  stats uri /

listen stats <%="#{node[:bcpc][:management][:ip]}"%>:1936
  mode http
  stats enable
  stats uri /
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%="#{get_config('haproxy-stats-user')}"%>:<%="#{get_config('haproxy-stats-password')}"%>

listen stats-vip <%="#{node[:bcpc][:management][:vip]}"%>:1936
  mode http
  server myself <%="#{node[:bcpc][:management][:ip]}"%>:1936

listen memcached <%="#{node[:bcpc][:management][:vip]}"%>:11211
  mode tcp
  option tcpka
  server myself 127.0.0.1:11211

listen mysql-galera <%="#{node[:bcpc][:management][:vip]}"%>:3306
  timeout  client 24h
  timeout  server 24h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
  option httpchk
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:3306 check port 3307 inter 1s rise 1 fall 1 observe layer4 backup" %>
<% end -%>

listen rabbitmq-amqp <%="#{node[:bcpc][:management][:vip]}"%>:5672
  timeout  client 24h
  timeout  server 24h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
  option httpchk
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:5672 check port 5673 inter 1s rise 1 fall 1 observe layer4" %>
<% end -%>

listen rabbitmq-web <%="#{node[:bcpc][:management][:vip]}"%>:55672
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:55672 check inter 1s rise 1 fall 1" %>
<% end -%>

listen ldap-389ds <%="#{node[:bcpc][:management][:vip]}"%>:389
  timeout  client 1h
  timeout  server 1h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:389 check inter 1s rise 1 fall 1 observe layer4" %>
<% end -%>

listen keystone-api <%="#{node[:bcpc][:management][:vip]}"%>:5000
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:5000 check inter 1s rise 1 fall 1" %>
<% end -%>

listen keystone-admin <%="#{node[:bcpc][:management][:vip]}"%>:35357
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:35357 check inter 1s rise 1 fall 1" %>
<% end -%>

listen glance-api <%="#{node[:bcpc][:management][:vip]}"%>:9292
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:9292 check inter 1s rise 1 fall 1" %>
<% end -%>

listen glance-registry <%="#{node[:bcpc][:management][:vip]}"%>:9191
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:9191 check inter 1s rise 1 fall 1" %>
<% end -%>

listen cinder-api <%="#{node[:bcpc][:management][:vip]}"%>:8776
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:8776 check inter 1s rise 1 fall 1" %>
<% end -%>

listen nova-ec2 <%="#{node[:bcpc][:management][:vip]}"%>:8773
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:8773 check inter 1s rise 1 fall 1" %>
<% end -%>

listen nova-compute <%="#{node[:bcpc][:management][:vip]}"%>:8774
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:8774 check inter 1s rise 1 fall 1" %>
<% end -%>

listen horizon-http <%="#{node[:bcpc][:management][:vip]}"%>:80
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:80 check inter 1s rise 1 fall 1" %>
<% end -%>

listen horizon-https <%="#{node[:bcpc][:management][:vip]}"%>:443
  mode tcp
  balance source
  option  tcplog
  option tcpka
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:443 check inter 1s rise 1 fall 1 observe layer4" %>
<% end -%>

listen elasticsearch <%="#{node[:bcpc][:management][:vip]}"%>:9200
  balance  source
  option  tcplog
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:9200 check inter 1s rise 1 fall 1" %>
<% end -%>

listen logstash-zmq <%="#{node[:bcpc][:management][:vip]}"%>:5556
  timeout  client 1h
  timeout  server 1h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
<% @servers.each do |server| -%>
  <%= "server #{server.hostname} #{server[:bcpc][:management][:ip]}:5556 check inter 1s rise 1 fall 1 observe layer4" %>
<% end -%>
