################################################
#
#              Generated by Chef
#
################################################

Listen <%="#{node[:bcpc][:graphite][:ip]}"%>:<%="#{node[:bcpc][:graphite][:web_port]}"%>
<% unless node[:bcpc][:graphite][:ip] == node[:bcpc][:management][:ip] -%>
Listen <%="#{node[:bcpc][:management][:ip]}"%>:<%="#{node[:bcpc][:graphite][:web_port]}"%>
<% end -%>
NameVirtualHost <%="#{node[:bcpc][:management][:ip]}"%>:443


<% unless node[:bcpc][:graphite][:ip] == node[:bcpc][:management][:ip] -%>
<VirtualHost <%="#{node[:bcpc][:graphite][:ip]}"%>:<%="#{node[:bcpc][:graphite][:web_port]}"%> <%="#{node[:bcpc][:management][:ip]}"%>:443 <%="#{node[:bcpc][:management][:ip]}"%>:<%="#{node[:bcpc][:graphite][:web_port]}"%>>
<% else -%>
<VirtualHost <%="#{node[:bcpc][:graphite][:ip]}"%>:<%="#{node[:bcpc][:graphite][:web_port]}"%> <%="#{node[:bcpc][:management][:ip]}"%>:443  >
<% end -%>

    ServerName "graphite.<%="#{node[:bcpc][:domain_name]}"%>"
    DocumentRoot "/opt/graphite/webapp"

    # I've found that an equal number of processes & threads tends
    # to show the best performance for Graphite (ymmv).
    WSGIDaemonProcess graphite processes=5 threads=5 user=www-data group=www-data inactivity-timeout=120
    WSGIProcessGroup graphite
    WSGIApplicationGroup www-data
    WSGIImportScript /opt/graphite/conf/graphite.wsgi process-group=graphite application-group=www-data

    WSGIScriptAlias / /opt/graphite/conf/graphite.wsgi
    <Directory /opt/graphite/conf/>
      <IfVersion < 2.4>
        Order deny,allow
        Allow from all
      </IfVersion>
      <IfVersion >= 2.4>
        Require all granted
      </IfVersion>
    </Directory>

    <Directory /opt/graphite/webapp/>
      <IfVersion < 2.4>
        Order deny,allow
        Allow from all
      </IfVersion>
      <IfVersion >= 2.4>
        Require all granted
      </IfVersion>
    </Directory>

    Alias /static/ /opt/graphite/webapp/content/
    <Location "/content/">
        SetHandler None
    </Location>

    # XXX In order for the django admin site media to work you
    # must change @DJANGO_ROOT@ to be the path to your django
    # installation, which is probably something like:
    # /usr/lib/python2.6/site-packages/django
    Alias /media/ "/usr/lib/python2.7/dist-packages/django/contrib/admin/media/"
    <Location "/media/">
        SetHandler None
    </Location>

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-bcpc.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-bcpc.key
</VirtualHost>
